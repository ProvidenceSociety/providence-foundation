{% extends "base.html" %}
{% block content %}

<section class="mt-6">
  <div class="flex items-end justify-between gap-4 flex-wrap">
    <h2 class="font-serif text-2xl">Donor Engagement Dashboard</h2>
    <a href="{{ url_for('projects') }}" class="text-sm underline">Back to Projects</a>
  </div>
  <p class="mt-2 text-neutral-700">
    Track the progress of each initiative and (optionally) keep your own giving goals on this device.
  </p>

  <!-- Organization-wide Progress -->
  <div class="mt-6 rounded-2xl border border-[#d4c8b5] bg-white p-6">
    <h3 class="font-serif text-xl mb-4">Project Progress</h3>
    <div class="grid md:grid-cols-2 gap-6">
      {% for p in projects %}
      <div class="rounded-xl border border-[#ece4d7] p-4">
        <div class="flex items-center justify-between">
          <div class="font-serif text-lg">{{ p.title }}</div>
          <div class="text-sm text-neutral-600">{{ p.percent }}%</div>
        </div>
        <div class="mt-2 text-sm text-neutral-700">
          Raised: ${{ "{:,}".format(p.raised) }} / ${{ "{:,}".format(p.target) }}
        </div>
        <div class="mt-3 h-3 w-full bg-[#f1eadf] rounded-full overflow-hidden">
          <div class="h-3 bg-[#b8a88b]" style="width: {{ p.percent }}%"></div>
        </div>
        <div class="mt-4 flex gap-2">
          <a href="{{ url_for('projects') }}"
             class="px-4 py-2 rounded-lg border border-[#d4c8b5] bg-white hover:bg-[#fffefd] transition font-serif text-sm">
            Learn More
          </a>
          <!-- Optional: jump straight to donate link if you map slugs -> DONATION_LINKS -->
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Personal Giving Tracker (local-only) -->
  <div class="mt-6 rounded-2xl border border-[#d4c8b5] bg-white p-6">
    <h3 class="font-serif text-xl">Your Personal Giving Tracker</h3>
    <p class="text-neutral-700">
      Keep a private goal and log your gifts on this device. Data is stored in your browser (no account needed).
    </p>

    <div class="mt-4 grid md:grid-cols-3 gap-4 items-end">
      <div>
        <label class="block text-sm mb-1">Monthly Giving Goal (USD)</label>
        <input id="goal" type="number" min="0" class="w-full rounded-lg border border-[#d4c8b5] bg-[#f9f6f0] px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm mb-1">Add a Gift (USD)</label>
        <div class="flex gap-2">
          <input id="gift" type="number" min="0" class="w-full rounded-lg border border-[#d4c8b5] bg-[#f9f6f0] px-3 py-2" />
          <button id="addGiftBtn"
                  class="px-4 py-2 rounded-lg border border-[#b8a88b] bg-[#e9e2d6] hover:bg-[#e2d8c7] transition font-serif">
            Add
          </button>
        </div>
      </div>
      <div class="flex gap-2">
        <button id="saveGoalBtn"
                class="px-4 py-2 rounded-lg border border-[#b8a88b] bg-[#e9e2d6] hover:bg-[#e2d8c7] transition font-serif">
          Save Goal
        </button>
        <button id="resetBtn"
                class="px-4 py-2 rounded-lg border border-[#d4c8b5] bg-white hover:bg-[#fffefd] transition font-serif">
          Reset
        </button>
      </div>
    </div>

    <div class="mt-6">
      <div class="flex items-center justify-between">
        <div class="text-neutral-700">
          <span class="font-serif">This Month:</span>
          $<span id="givenTotal">0</span> of $<span id="goalAmount">0</span>
        </div>
        <div class="text-sm text-neutral-600"><span id="percentText">0%</span></div>
      </div>
      <div class="mt-2 h-3 w-full bg-[#f1eadf] rounded-full overflow-hidden">
        <div id="personalBar" class="h-3 bg-[#b8a88b]" style="width:0%"></div>
      </div>
      <div class="mt-3 text-sm text-neutral-600" id="giftList"></div>
    </div>
  </div>
</section>

<script>
  // --- Personal Tracker (localStorage) ---
  const LS_KEY = "pf_personal_giving";
  const el = (id) => document.getElementById(id);

  function loadState() {
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }
    catch { return {}; }
  }

  function saveState(state) {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function monthKey(d = new Date()) {
    return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
  }

  function stateForCurrentMonth(state) {
    const mk = monthKey();
    state.months = state.months || {};
    state.months[mk] = state.months[mk] || { goal: 0, gifts: [] };
    return state.months[mk];
  }

  function render() {
    const state = loadState();
    const m = stateForCurrentMonth(state);
    el("goal").value = m.goal || 0;

    const total = (m.gifts || []).reduce((a, g) => a + Number(g.amount || 0), 0);
    el("givenTotal").innerText = total.toLocaleString();
    el("goalAmount").innerText = Number(m.goal || 0).toLocaleString();

    const percent = Math.min(100, m.goal > 0 ? Math.round((total / m.goal) * 100) : 0);
    el("percentText").innerText = percent + "%";
    el("personalBar").style.width = percent + "%";

    // Gift list (compact)
    const list = (m.gifts || []).slice().reverse().map(g =>
      `â€¢ $${Number(g.amount).toLocaleString()} on ${new Date(g.ts).toLocaleDateString()}`
    ).join("<br>");
    el("giftList").innerHTML = list || "<em>No gifts logged yet this month.</em>";
  }

  el("saveGoalBtn").addEventListener("click", () => {
    const state = loadState();
    const m = stateForCurrentMonth(state);
    m.goal = Math.max(0, Number(el("goal").value || 0));
    saveState(state);
    render();
  });

  el("addGiftBtn").addEventListener("click", () => {
    const amt = Math.max(0, Number(el("gift").value || 0));
    if (!amt) return;
    const state = loadState();
    const m = stateForCurrentMonth(state);
    m.gifts.push({ amount: amt, ts: Date.now() });
    el("gift").value = "";
    saveState(state);
    render();
  });

  el("resetBtn").addEventListener("click", () => {
    if (!confirm("Reset this month's goal and gifts on this device?")) return;
    const state = loadState();
    const mk = monthKey();
    if (state.months && state.months[mk]) state.months[mk] = { goal: 0, gifts: [] };
    saveState(state);
    render();
  });

  render();
</script>

{% endblock %}
